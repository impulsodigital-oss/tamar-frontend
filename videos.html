<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aula Virtual - Tamar</title>
    <link rel="stylesheet" href="CSS/style.css">
    <style>
        body { background-color: #f4f6f9; font-family: 'Lato', sans-serif; }
        .classroom-container { display: grid; grid-template-columns: 320px 1fr; gap: 0; min-height: calc(100vh - 80px); }
        .course-sidebar { background: white; border-right: 1px solid #e0e0e0; height: calc(100vh - 80px); overflow-y: auto; position: sticky; top: 80px; }
        .sidebar-header { padding: 25px; background: var(--color-azul-profundo); color: white; }
        .lesson-list { list-style: none; padding: 0; margin: 0; }
        .lesson-item { border-bottom: 1px solid #f0f0f0; cursor: pointer; padding: 18px 25px; display: flex; gap: 12px; }
        .lesson-item.active { background-color: #eef1f4; border-left: 5px solid var(--color-acento); }
        .lesson-item.completed .lesson-title { color: #888; text-decoration: line-through; }
        .lesson-title { font-weight: 700; display: block; }
        .course-content { padding: 40px 60px; max-width: 1200px; margin: 0 auto; }
        
        /* GRID DE AULAS */
        .hub-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
        .hub-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); border-top: 4px solid var(--color-acento); display: flex; flex-direction: column; justify-content: space-between; }
        .btn-zoom-card { background: var(--color-azul-profundo); color: white; text-decoration: none; padding: 10px; border-radius: 6px; text-align: center; font-weight: bold; display: block; margin-top: 10px; }
        
        /* VIDEO */
        .video-wrapper { position: relative; padding-bottom: 56.25%; height: 0; background: black; border-radius: 12px; margin-bottom: 30px; }
        .video-wrapper iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        
        /* TABS */
        .tabs-header { display: flex; border-bottom: 2px solid #f0f0f0; margin-bottom: 20px; }
        .tab-btn { padding: 10px 20px; border: none; background: none; cursor: pointer; font-weight: bold; color: #777; }
        .tab-btn.active { color: var(--color-azul-profundo); border-bottom: 3px solid var(--color-acento); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .btn-complete { background-color: #e0e0e0; padding: 10px 20px; border-radius: 5px; border: none; cursor: pointer; font-weight: bold; }
        .btn-complete.completed { background-color: #27ae60; color: white; }

        @media (max-width: 900px) { .classroom-container { display: block; } .course-sidebar { width: 100%; position: relative; height: auto; } }
    </style>
</head>
<body>
    <header class="header">
        <div class="container">
            <img src="images/logo-tamar.png" alt="Logo Tamar" class="logo">
            <nav class="nav"><ul><li><a href="#" id="logout-btn">Cerrar SesiÃ³n</a></li></ul></nav>
        </div>
    </header>

    <div id="loading-screen" style="text-align: center; padding: 100px;">
        <h2>ðŸŽ“ Cargando...</h2>
    </div>

    <div id="classroom-ui" class="classroom-container" style="display: none;">
        <aside class="course-sidebar">
            <div class="sidebar-header">
                <h4>Tu Progreso</h4>
                <div id="user-badge" style="background: rgba(255,255,255,0.2); padding: 5px 10px; border-radius: 4px; font-size: 0.8rem; margin-top: 5px;">Alumno</div>
            </div>
            <ul id="lesson-list-ul" class="lesson-list"></ul>
        </aside>

        <main class="course-content">
            <h2 style="margin-top:0; color:var(--color-azul-profundo);">ðŸ”´ Aulas Virtuales</h2>
            <p id="nivel-info" style="color:#666; margin-bottom: 20px;">Tus clases en vivo:</p>
            <div id="hub-grid" class="hub-grid"></div>

            <hr style="margin: 40px 0; border: 0; border-top: 1px solid #eee;">

            <h2>ðŸ“š Lecciones Grabadas</h2>
            <div id="video-area">
                <div class="video-wrapper"><iframe id="main-video-frame" src="" allowfullscreen></iframe></div>
                
                <div class="tabs-header">
                    <button id="btn-tab-desc" class="tab-btn active" onclick="switchTab('desc')">DescripciÃ³n</button>
                    <button id="btn-tab-resources" class="tab-btn" onclick="switchTab('resources')">Recursos</button>
                </div>

                <div id="tab-desc" class="tab-content active">
                    <button id="btn-mark-complete" class="btn-complete" style="float:right;">Marcar Vista</button>
                    <h3 id="main-video-title">...</h3>
                    <p id="main-video-desc">...</p>
                </div>
                <div id="tab-resources" class="tab-content">
                    <div id="resources-container"></div>
                </div>
            </div>
        </main>
    </div>

    <script type="module" src="js/api.js"></script>
    <script type="module" src="js/main.js"></script>
    <script type="module">
        import { getData, postData, getAuthToken } from './js/api.js';

        let allVideos = [];
        let currentVideoIndex = 0;
        let userLevel = 'general'; // Nivel del usuario

        window.switchTab = (tabName) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');
            document.getElementById(`btn-tab-${tabName}`).classList.add('active');
        };

        document.addEventListener('DOMContentLoaded', async () => {
            const token = getAuthToken();
            if (!token) { window.location.href = 'login.html'; return; }

            document.getElementById('logout-btn').addEventListener('click', () => { localStorage.removeItem('token'); window.location.href = 'index.html'; });

            try {
                const response = await getData('videos', token);
                const data = await response.json();
                document.getElementById('loading-screen').style.display = 'none';

                if (response.ok) {
                    if (data.videos) {
                        allVideos = data.videos;
                        userLevel = data.userLevel || 'general'; // Capturamos el nivel
                        
                        // Mostrar Nivel en Sidebar
                        document.getElementById('user-badge').textContent = `Nivel: ${userLevel.toUpperCase()}`;
                        document.getElementById('nivel-info').textContent = `Mostrando clases para: ${userLevel.toUpperCase()}`;

                        document.getElementById('classroom-ui').style.display = 'grid';
                        renderSidebar(allVideos);
                        loadVideo(0);
                        loadClassroomsGrid(token);
                    }
                } else if (response.status === 403) {
                    renderPaymentWall();
                }
            } catch (e) { alert('Error de conexiÃ³n'); }
        });

        function renderSidebar(videos) {
            document.getElementById('lesson-list-ul').innerHTML = videos.map((v, i) => `
                <li class="lesson-item ${v.completado ? 'completed' : ''}" onclick="window.loadVideo(${i})">
                    <span class="lesson-title">${v.titulo_corto || v.titulo_completo}</span>
                </li>`).join('');
        }

        window.loadVideo = (index) => {
            currentVideoIndex = index;
            const video = allVideos[index];
            const url = video.url_video.replace('watch?v=', 'embed/');
            document.getElementById('main-video-frame').src = url;
            document.getElementById('main-video-title').textContent = video.titulo_completo;
            
            // Links en descripciÃ³n
            const desc = video.descripcion || '';
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            const links = desc.match(urlRegex);
            document.getElementById('main-video-desc').textContent = desc.replace(urlRegex, '');
            
            const resContainer = document.getElementById('resources-container');
            resContainer.innerHTML = links ? links.map(l => `<a href="${l}" target="_blank" class="btn-zoom-card" style="background:#fff; color:#333; border:1px solid #ccc;">ðŸ“‚ Descargar Material</a>`).join('') : '<p>Sin adjuntos.</p>';

            const btn = document.getElementById('btn-mark-complete');
            if(video.completado) { btn.textContent = 'âœ… Completada'; btn.classList.add('completed'); }
            else { btn.textContent = 'Marcar Vista'; btn.classList.remove('completed'); }
        };

        async function loadClassroomsGrid(token) {
            const res = await getData('clases-en-vivo', token);
            const data = await res.json();
            const grid = document.getElementById('hub-grid');
            
            // FILTRO DE NIVEL
            const filteredClasses = data.clases.filter(c => 
                c.nivel_objetivo === userLevel || // Coincide exacto (ej: kinder === kinder)
                c.nivel_objetivo === 'general' || // Es para todos
                !c.nivel_objetivo // Si no tiene nivel, mostrar por las dudas
            );

            if (filteredClasses.length > 0) {
                grid.innerHTML = filteredClasses.map(c => `
                    <div class="hub-card">
                        <h4>${c.titulo}</h4>
                        <small>${c.profesor || ''}</small>
                        <a href="${c.link_zoom}" target="_blank" class="btn-zoom-card">ðŸŽ¥ Entrar</a>
                        ${c.link_recursos ? `<a href="${c.link_recursos}" target="_blank" style="display:block; text-align:center; margin-top:10px; color:#666;">ðŸ“‚ Drive</a>` : ''}
                    </div>
                `).join('');
            } else {
                grid.innerHTML = '<p>No hay clases activas para tu nivel.</p>';
            }
        }

        document.getElementById('btn-mark-complete').addEventListener('click', async () => {
            await postData('progreso', { videoId: allVideos[currentVideoIndex].id }, getAuthToken());
            allVideos[currentVideoIndex].completado = true;
            renderSidebar(allVideos);
            loadVideo(currentVideoIndex);
        });

        // PAYMENT WALL (Simplificado para ahorrar espacio, lÃ³gica igual al anterior)
        function renderPaymentWall() {
            document.getElementById('classroom-ui').style.display = 'block';
            document.querySelector('.course-sidebar').style.display = 'none';
            document.querySelector('.course-content').innerHTML = `
                <div style="text-align:center; padding:50px;">
                    <h1>ðŸ”’ InscripciÃ³n a Tamar</h1>
                    <div style="background:white; padding:30px; border-radius:10px; max-width:500px; margin:0 auto; text-align:left;">
                        <label><strong>1. Nivel:</strong></label>
                        <select id="level-selector" style="width:100%; padding:10px; margin-bottom:15px;">
                            <option value="kinder">Kinder</option><option value="primaria">Primaria</option>
                            <option value="secundaria_middle">Middle School</option><option value="secundaria_high">High School</option>
                        </select>
                        <label><strong>2. Plan:</strong></label>
                        <select id="plan-selector" style="width:100%; padding:10px; margin-bottom:20px;">
                            <option value="basico">BÃ¡sico ($46.800)</option>
                            <option value="core">Core ($70.800)</option>
                            <option value="plus">Plus ($154.800)</option>
                        </select>
                        <button onclick="pagarMP()" class="btn-zoom-card" style="background:#009ee3;">Pagar MP</button>
                        <button onclick="pagarPayPal()" class="btn-zoom-card" style="background:#003087;">Pagar PayPal</button>
                    </div>
                </div>
            `;
            window.pagarMP = async () => {
                try {
                    const res = await postData('crear-pago', { planId: document.getElementById('plan-selector').value, nivel: document.getElementById('level-selector').value }, getAuthToken());
                    const data = await res.json();
                    if (data.init_point) window.location.href = data.init_point;
                } catch(e) { alert('Error MP'); }
            };
            window.pagarPayPal = async () => {
                try {
                    const res = await postData('crear-pago-paypal', { planId: document.getElementById('plan-selector').value, nivel: document.getElementById('level-selector').value }, getAuthToken());
                    const data = await res.json();
                    if (data.links) window.location.href = data.links.find(l => l.rel === 'approve').href;
                } catch(e) { alert('Error PayPal'); }
            };
        }
    </script>
</body>
</html>
