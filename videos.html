<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aula Virtual - Tamar</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="CSS/style.css">
    
    <style>
        body { background-color: #f8f9fa; }
        .classroom-container { display: grid; grid-template-columns: 350px 1fr; gap: 0; min-height: calc(100vh - 80px); margin-top: 0; }
        .course-sidebar { background: white; border-right: 1px solid #e0e0e0; height: calc(100vh - 80px); overflow-y: auto; position: fixed; width: 350px; top: 80px; bottom: 0; z-index: 10; }
        .sidebar-header { padding: 20px; background: var(--color-azul-profundo); color: white; }
        .progress-container { margin-top: 10px; }
        .progress-bar-bg { background: rgba(255,255,255,0.2); height: 6px; border-radius: 3px; overflow: hidden; }
        .progress-bar-fill { background: var(--color-acento); height: 100%; width: 0%; transition: width 0.5s ease; }
        .progress-text { font-size: 0.8rem; margin-top: 5px; display: flex; justify-content: space-between; }
        .lesson-list { list-style: none; padding: 0; margin: 0; }
        .lesson-item { border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: background 0.2s; padding: 15px 20px; display: flex; align-items: flex-start; gap: 10px; }
        .lesson-item:hover { background-color: #f9f9f9; }
        .lesson-item.active { background-color: #eef1f4; border-left: 4px solid var(--color-acento); }
        .lesson-item.completed .lesson-title { color: #888; text-decoration: line-through; }
        .check-icon { width: 20px; height: 20px; border: 2px solid #ccc; border-radius: 50%; flex-shrink: 0; margin-top: 2px; display: flex; align-items: center; justify-content: center; font-size: 12px; }
        .lesson-item.completed .check-icon { background-color: #28a745; border-color: #28a745; color: white; }
        .lesson-title { font-size: 0.95rem; font-weight: 700; color: #333; margin-bottom: 4px; display: block; }
        .lesson-meta { font-size: 0.8rem; color: #777; }
        .course-content { margin-left: 350px; padding: 40px; max-width: 1000px; }
        .video-wrapper { position: relative; padding-bottom: 56.25%; height: 0; background: black; border-radius: 12px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.15); margin-bottom: 30px; }
        .video-wrapper iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0; }
        .lesson-header { margin-bottom: 20px; border-bottom: 1px solid #ddd; padding-bottom: 20px; }
        .lesson-header h2 { margin-bottom: 10px; text-align: left; font-size: 2rem; }
        .lesson-header h2::after { display: none; }
        
        /* Modal Clases */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: none; justify-content: center; align-items: center; }
        .modal-content { background: white; width: 90%; max-width: 800px; max-height: 80vh; overflow-y: auto; border-radius: 12px; padding: 30px; position: relative; }
        .close-modal { position: absolute; top: 15px; right: 20px; font-size: 2rem; cursor: pointer; color: #666; }
        .live-class-card { display: flex; gap: 20px; border: 1px solid #eee; border-radius: 8px; padding: 20px; margin-bottom: 20px; align-items: center; transition: transform 0.2s; }
        .live-class-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .class-date { background: var(--color-fondo); padding: 15px; border-radius: 8px; text-align: center; min-width: 100px; }
        .date-day { font-size: 1.5rem; font-weight: 800; color: var(--color-azul-profundo); display: block; }
        .date-month { font-size: 0.9rem; text-transform: uppercase; color: #666; }
        .class-info { flex-grow: 1; }
        .badge-materia { background: #e0f2f1; color: #00695c; padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; display: inline-block; margin-bottom: 5px; }
        .class-actions { display: flex; flex-direction: column; gap: 10px; min-width: 160px; }
        .btn-zoom { background-color: #2D8CFF; color: white; text-align: center; padding: 8px; border-radius: 5px; text-decoration: none; font-weight: bold; font-size: 0.9rem; }
        .btn-materials { background-color: #f1f3f4; color: #333; text-align: center; padding: 8px; border-radius: 5px; text-decoration: none; font-size: 0.9rem; border: 1px solid #ccc; }

        /* Estilos para la lista de beneficios del Plan */
        .plan-features { background-color: #f1f8ff; padding: 20px; border-radius: 8px; margin-bottom: 25px; border-left: 5px solid var(--color-acento); }
        .plan-features h4 { margin-top: 0; color: var(--color-azul-profundo); }
        .plan-features ul { margin: 10px 0 0 20px; padding: 0; }
        .plan-features li { margin-bottom: 8px; color: #555; }

        @media (max-width: 900px) {
            .classroom-container { display: block; }
            .course-sidebar { position: relative; width: 100%; height: auto; top: 0; border-right: none; border-bottom: 1px solid #ddd; order: 2; }
            .course-content { margin-left: 0; padding: 20px; order: 1; }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="container">
            <img src="images/logo-tamar.png" alt="Logo Tamar" class="logo">
            <nav class="nav">
                <ul>
                    <li><a href="index.html">Inicio</a></li>
                    <li><a href="#" onclick="window.mostrarClasesVivo()" style="color: var(--color-acento); font-weight: bold;">üî¥ Clases en Vivo</a></li>
                    <li><a href="#" id="logout-btn">Cerrar Sesi√≥n</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <div id="loading-screen" style="text-align: center; padding: 100px;">
        <p>Cargando tu aula virtual...</p>
    </div>

    <div id="classroom-ui" class="classroom-container" style="display: none;">
        <aside class="course-sidebar">
            <div class="sidebar-header">
                <h4>Tu Progreso</h4>
                <div class="progress-container">
                    <div class="progress-bar-bg"><div id="progress-fill" class="progress-bar-fill"></div></div>
                    <div class="progress-text"><span id="progress-percent">0%</span><span id="progress-count">0/0</span></div>
                </div>
            </div>
            <ul id="lesson-list-ul" class="lesson-list"></ul>
        </aside>

        <main class="course-content">
            <div id="video-area">
                <div class="video-wrapper"><iframe id="main-video-frame" src="" allow="autoplay; encrypted-media" allowfullscreen></iframe></div>
                <div class="lesson-header">
                    <h2 id="main-video-title">Selecciona una lecci√≥n</h2>
                    <p id="main-video-desc" style="color: #666;">...</p>
                    <div style="margin-top: 20px; display: flex; justify-content: space-between; align-items: center;">
                        <button id="btn-mark-complete" class="btn" style="background-image: none; background-color: #ccc;">Marcar como Vista</button>
                        <button id="btn-next-lesson" class="btn" style="display:none;">Siguiente Lecci√≥n ‚Üí</button>
                    </div>
                </div>
            </div>
            <div id="video-message" class="message" style="display:none;"></div>
        </main>
    </div>

    <div id="live-modal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-modal" onclick="document.getElementById('live-modal').style.display='none'">&times;</span>
            <h2 style="color: var(--color-azul-profundo); border-bottom: 2px solid #eee; padding-bottom: 15px; margin-bottom: 20px;">üìÖ Calendario de Clases en Vivo</h2>
            <div id="live-classes-list"><p>Cargando clases...</p></div>
        </div>
    </div>

    <footer><div class="container"><p>&copy; 2024 Tamar. Plataforma Educativa.</p></div></footer>

    <a href="https://wa.me/5493412757827?text=Hola%20Tamar,%20tengo%20una%20consulta%20sobre%20la%20plataforma." class="support-btn" target="_blank" title="Contactar Soporte">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M380.9 97.1C339 55.1 283.2 32 223.9 32c-122.4 0-222 99.6-222 222 0 39.1 10.2 77.3 29.6 111L0 480l117.7-30.9c32.4 17.7 68.9 27 106.1 27h.1c122.3 0 224.1-99.6 224.1-222 0-59.3-25.2-115-67.1-157zm-157 341.6c-33.2 0-65.7-8.9-94-25.7l-6.7-4-69.8 18.3 18.6-68.1-4.4-6.9c-18.3-29.1-28-63-28-97.6 0-101.6 82.9-184.3 184.6-184.3 49.3 0 95.6 19.2 130.4 54.1 34.8 34.9 56.2 81.2 56.1 130.5 0 101.8-84.9 184.6-186.6 184.6zm101.2-138.2c-5.5-2.8-32.8-16.2-37.9-18-5.1-1.9-8.8-2.8-12.5 2.8-3.7 5.6-14.3 18-17.6 21.8-3.2 3.7-6.5 4.2-12 1.4-32.6-16.3-54-29.1-75.5-66-5.7-9.8 5.7-9.1 16.3-30.3 1.8-3.7.9-6.9-.5-9.7-1.4-2.8-12.5-30.1-17.1-41.2-4.5-10.8-9.1-9.3-12.5-9.5-3.2-.2-6.9-.2-10.6-.2-3.7 0-9.7 1.4-14.8 6.9-5.1 5.6-19.4 19-19.4 46.3 0 27.3 19.9 53.7 22.6 57.4 2.8 3.7 39.1 59.7 94.8 83.8 35.2 15.2 49 16.5 66.6 13.9 10.7-1.6 32.8-13.4 37.4-26.4 4.6-13 4.6-24.1 3.2-26.4-1.3-2.5-5-3.9-10.5-6.6z"/></svg>
    </a>

    <script type="module" src="js/api.js"></script>
    <script type="module" src="js/main.js"></script>
    <script type="module">
        import { getData, postData, getAuthToken } from './js/api.js';
        import { showMessage, hideMessage } from './js/main.js';

        // --- DATOS DE LOS PLANES ---
        const PLAN_DETAILS = {
            'basico': {
                features: [
                    'Acceso a videos cortos y pr√°cticos ',
                    'Comunidad en l√≠nea para dudas ',
                    'Grupo de estudio por a√±o cursado ',
                    'Clases de ARTE gratis ',
                    'Asesoramiento mensual para carpeta de evidencias ',
                    'Descuento en plataforma educativa SKEPSI '
                ]
            },
            'core': {
                features: [
                    'Todo lo del Plan B√°sico ',
                    '3 Clases grupales mensuales (1h c/u) ',
                    'Elecci√≥n de 3 docentes ',
                    'Comunidad directa con docentes ',
                    'Descuento en clases extras '
                ]
            },
            'plus': {
                features: [
                    'Todo lo del Plan B√°sico ',
                    '10 Clases grupales mensuales (1h c/u) ',
                    'Elecci√≥n de docentes ',
                    'Comunidad directa con docentes ',
                    'Descuento en clases extras '
                ]
            },
            'selecto': {
                features: [
                    'Todo lo del Plan B√°sico ',
                    '4 Clases SEMANALES (16 al mes aprox) ',
                    '40 minutos m√≠nimo por clase ',
                    'Elecci√≥n de 4 profesores ',
                    'Comunidad directa con profesores '
                ]
            },
            'completo': {
                features: [
                    'Todo lo del Plan B√°sico',
                    '10 Clases SEMANALES (40 al mes aprox) ',
                    'Incluye las 10 materias b√°sicas ',
                    '40 minutos m√≠nimo por clase ',
                    'Comunidad directa con profesores '
                ]
            },
            'certificacion': {
                features: [
                    'Matr√≠cula con Integrative Learning (USA) ',
                    'Constancia de inscripci√≥n y Credencial',
                    'Acreditaci√≥n acad√©mica (Bolet√≠n de notas) ',
                    'Gesti√≥n de Transcript y Diploma (12¬∞ a√±o)',
                    'Asesoramiento para desescolarizaci√≥n '
                ]
            }
        };

        let allVideos = [];
        let currentVideoIndex = 0;

        document.addEventListener('DOMContentLoaded', async () => {
            const token = getAuthToken();
            if (!token) { window.location.href = 'login.html'; return; }

            document.getElementById('logout-btn').addEventListener('click', (e) => {
                e.preventDefault(); localStorage.removeItem('token'); window.location.href = 'index.html';
            });

            // Pagos
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('status') === 'success') {
                showMessage('video-message', '¬°Pago con Mercado Pago exitoso! Activando...', 'success');
                setTimeout(() => window.location.href = 'videos.html', 3000);
            }
            if (urlParams.get('status') === 'paypal_success' && urlParams.get('token')) {
                showMessage('video-message', 'Procesando PayPal...', 'success');
                try {
                    const response = await postData('capturar-pago-paypal', { orderID: urlParams.get('token'), planId: urlParams.get('plan') }, token);
                    if(response.ok) setTimeout(() => window.location.href = 'videos.html', 3000);
                } catch(e) { console.error(e); }
            }

            // Cargar Videos
            try {
                const response = await getData('videos', token);
                const data = await response.json();
                document.getElementById('loading-screen').style.display = 'none';

                if (response.ok) {
                    // CASO 1: ALUMNO ACTIVO
                    if (data.videos && data.videos.length > 0) {
                        allVideos = data.videos;
                        document.getElementById('classroom-ui').style.display = 'grid';
                        renderSidebar(allVideos);
                        const firstUnwatched = allVideos.findIndex(v => !v.completado);
                        loadVideo(firstUnwatched !== -1 ? firstUnwatched : 0);
                    } else {
                        document.getElementById('classroom-ui').style.display = 'grid';
                        document.querySelector('.course-content').innerHTML = '<div style="padding:50px; text-align:center;"><h3>¬°Bienvenido!</h3><p>A√∫n no hay lecciones publicadas.</p></div>';
                    }
                } else if (response.status === 403 && data.requierePago) {
                    // CASO 2: NUEVO ALUMNO (PAGOS)
                    const container = document.getElementById('classroom-ui');
                    container.style.display = 'block';
                    
                    const sidebar = document.querySelector('.course-sidebar');
                    if(sidebar) sidebar.style.display = 'none';

                    const content = document.querySelector('.course-content');
                    content.style.marginLeft = '0'; 
                    content.style.maxWidth = '100%';

                    // Inyectamos HTML de Pagos Mejorado
                    content.innerHTML = `
                        <div style="text-align: center; padding: 40px; max-width: 900px; margin: 0 auto;">
                            <h1 style="color: var(--color-azul-profundo); margin-bottom: 10px;">üîí Inscripci√≥n a Tamar</h1>
                            <p style="font-size: 1.1rem; margin-bottom: 30px; color:#666;">Selecciona el plan educativo para ver sus beneficios.</p>
                            
                            <div style="background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);">
                                <div style="margin-bottom: 20px; text-align: left;">
                                    <label style="display:block; font-weight:bold; margin-bottom:10px; color: var(--color-azul-profundo);">Elige tu Plan:</label>
                                    <select id="plan-selector" style="width:100%; padding:15px; border-radius:8px; border:2px solid #eee; font-size:1.1rem; font-family: 'Lato', sans-serif;">
                                        <option value="basico" data-ars="46800" data-usd="39">Plan B√°sico ($46.800 ARS / $39 USD)</option>
                                        <option value="core" data-ars="70800" data-usd="59">Plan Core ($70.800 ARS / $59 USD)</option>
                                        <option value="plus" data-ars="154800" data-usd="129">Plan Plus ($154.800 ARS / $129 USD)</option>
                                        <option value="selecto" data-ars="130800" data-usd="109">Plan Selecto ($130.800 ARS / $109 USD)</option>
                                        <option value="completo" data-ars="274800" data-usd="229">Plan Completo ($274.800 ARS / $229 USD)</option>
                                        <option value="certificacion" data-ars="240000" data-usd="200">Certificaci√≥n Anual ($240.000 ARS / $200 USD)</option>
                                    </select>
                                </div>

                                <div id="plan-features-container" class="plan-features">
                                    <h4>‚ú® Incluye:</h4>
                                    <ul id="features-list">
                                    </ul>
                                </div>

                                <div style="display: grid; gap: 20px; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));">
                                    <div style="border: 1px solid #eee; padding: 20px; border-radius: 8px;">
                                        <h4>üá¶üá∑ Argentina</h4>
                                        <p id="price-display-ars" style="font-size: 1.5rem; color: var(--color-acento); font-weight:bold; margin: 10px 0;">$46.800 ARS</p>
                                        <button onclick="window.pagarMP()" class="btn" style="width:100%; background: #009ee3;">Pagar con Mercado Pago</button>
                                    </div>
                                    <div style="border: 1px solid #eee; padding: 20px; border-radius: 8px;">
                                        <h4>üåç Internacional</h4>
                                        <p id="price-display-usd" style="font-size: 1.5rem; color: var(--color-acento); font-weight:bold; margin: 10px 0;">$39 USD</p>
                                        <button onclick="window.pagarPayPal()" class="btn" style="width:100%; background: #ffc439; color: #003087;">Pagar con PayPal</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Funci√≥n para actualizar la info del plan
                    const updatePlanInfo = () => {
                        const selector = document.getElementById('plan-selector');
                        const opt = selector.options[selector.selectedIndex];
                        const planKey = opt.value;
                        
                        // Actualizar Precios
                        document.getElementById('price-display-ars').textContent = `$${new Intl.NumberFormat('es-AR').format(opt.getAttribute('data-ars'))} ARS`;
                        document.getElementById('price-display-usd').textContent = `$${opt.getAttribute('data-usd')} USD`;

                        // Actualizar Beneficios
                        const details = PLAN_DETAILS[planKey];
                        const list = document.getElementById('features-list');
                        list.innerHTML = details ? details.features.map(f => `<li>${f}</li>`).join('') : '';
                    };

                    // Event Listeners
                    document.getElementById('plan-selector').addEventListener('change', updatePlanInfo);
                    
                    // Inicializar con el primer plan (B√°sico)
                    updatePlanInfo();
                }
            } catch (error) { 
                console.error(error);
                showMessage('video-message', 'Error de conexi√≥n. Intente refrescar.', 'error'); 
            }
        });

        // ... (El resto de funciones loadVideo, postData, etc. siguen igual que antes)
        function renderSidebar(videos) {
            const ul = document.getElementById('lesson-list-ul');
            ul.innerHTML = videos.map((video, index) => `
                <li class="lesson-item ${video.completado ? 'completed' : ''}" onclick="window.loadVideo(${index})">
                    <div class="check-icon">${video.completado ? '‚úî' : ''}</div>
                    <div class="lesson-info"><span class="lesson-title">${video.titulo_corto || video.titulo_completo}</span><span class="lesson-meta">M√≥dulo ${video.modulo}</span></div>
                </li>
            `).join('');
            updateProgress(videos);
        }

        window.loadVideo = (index) => {
            currentVideoIndex = index;
            const video = allVideos[index];
            document.querySelectorAll('.lesson-item').forEach((el, i) => el.classList.toggle('active', i === index));
            
            let url = video.url_video || '';
            if(url.includes('watch?v=')) url = url.replace('watch?v=', 'embed/');
            document.getElementById('main-video-frame').src = url;
            document.getElementById('main-video-title').textContent = video.titulo_completo;
            document.getElementById('main-video-desc').textContent = video.descripcion || '';

            const btnComplete = document.getElementById('btn-mark-complete');
            const btnNext = document.getElementById('btn-next-lesson');
            
            if (video.completado) {
                btnComplete.textContent = '‚úÖ Completada'; 
                btnComplete.style.backgroundColor = '#28a745'; 
                btnComplete.disabled = true;
                if (index < allVideos.length - 1) btnNext.style.display = 'inline-block';
            } else {
                btnComplete.textContent = 'Marcar como Vista'; 
                btnComplete.style.backgroundColor = 'var(--color-acento)'; 
                btnComplete.disabled = false; 
                btnNext.style.display = 'none';
            }
        };

        document.getElementById('btn-mark-complete').addEventListener('click', async () => {
            const btn = document.getElementById('btn-mark-complete');
            const originalText = btn.textContent;
            btn.textContent = 'Guardando...';
            btn.disabled = true;

            const video = allVideos[currentVideoIndex];
            const token = getAuthToken();
            
            try {
                const res = await postData('progreso', { videoId: video.id }, token);
                if (res.ok) { 
                    allVideos[currentVideoIndex].completado = true; 
                    renderSidebar(allVideos); 
                    loadVideo(currentVideoIndex); 
                } else {
                    btn.textContent = originalText;
                    btn.disabled = false;
                    alert('No se pudo guardar.');
                }
            } catch (e) { 
                console.error(e);
                btn.textContent = originalText;
                btn.disabled = false;
            }
        });

        document.getElementById('btn-next-lesson').addEventListener('click', () => { if (currentVideoIndex < allVideos.length - 1) loadVideo(currentVideoIndex + 1); });

        function updateProgress(videos) {
            const completedCount = videos.filter(v => v.completado).length;
            const total = videos.length;
            const percent = total === 0 ? 0 : Math.round((completedCount / total) * 100);
            document.getElementById('progress-fill').style.width = `${percent}%`;
            document.getElementById('progress-percent').textContent = `${percent}% Completado`;
            document.getElementById('progress-count').textContent = `${completedCount}/${total} Lecciones`;
        }

        window.pagarMP = async () => {
            const token = getAuthToken();
            const planId = document.getElementById('plan-selector').value;
            try { const res = await postData('crear-pago', { planId }, token); const data = await res.json(); if (data.init_point) window.location.href = data.init_point; } catch (e) { alert('Error MP'); }
        };
        window.pagarPayPal = async () => {
            const token = getAuthToken();
            const planId = document.getElementById('plan-selector').value;
            try { const res = await postData('crear-pago-paypal', { planId }, token); const data = await res.json(); const link = data.links.find(l => l.rel === 'approve'); if (link) window.location.href = link.href; } catch (e) { alert('Error PayPal'); }
        };
        window.mostrarClasesVivo = async () => {
             const token = getAuthToken();
             document.getElementById('live-modal').style.display = 'flex';
             try {
                 const res = await getData('clases-en-vivo', token);
                 if(res.status === 403) { document.getElementById('live-classes-list').innerHTML = '<p style="color:red;">Acceso restringido.</p>'; return; }
                 const data = await res.json();
                 if(!data.clases || data.clases.length === 0) { document.getElementById('live-classes-list').innerHTML = '<p>No hay clases.</p>'; return; }
                 document.getElementById('live-classes-list').innerHTML = data.clases.map(c => `
                    <div class="live-class-card">
                        <div class="class-date"><span class="date-day">${new Date(c.fecha_hora).getDate()}</span></div>
                        <div class="class-info"><span class="badge-materia">${c.materia || 'General'}</span><h3>${c.titulo}</h3><p>üë®‚Äçüè´ ${c.profesor}</p></div>
                        <div class="class-actions"><a href="${c.link_zoom}" target="_blank" class="btn-zoom">üé• Unirse</a>${c.link_recursos ? `<a href="${c.link_recursos}" target="_blank" class="btn-materials">üìÇ Materiales</a>` : ''}</div>
                    </div>
                 `).join('');
             } catch(e) { console.error(e); }
        }
    </script>
</body>
</html>
