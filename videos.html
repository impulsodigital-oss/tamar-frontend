<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aula Virtual - Tamar</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="CSS/style.css">
    
    <style>
        body { background-color: #f4f6f9; font-family: 'Lato', sans-serif; }
        
        .classroom-container { display: grid; grid-template-columns: 320px 1fr; gap: 0; min-height: calc(100vh - 80px); }
        .course-sidebar { background: white; border-right: 1px solid #e0e0e0; height: calc(100vh - 80px); overflow-y: auto; position: sticky; top: 80px; }
        .sidebar-header { padding: 25px; background: var(--color-azul-profundo); color: white; }
        .progress-container { margin-top: 15px; }
        .progress-bar-bg { background: rgba(255,255,255,0.2); height: 8px; border-radius: 4px; overflow: hidden; }
        .progress-bar-fill { background: var(--color-acento); height: 100%; width: 0%; transition: width 0.6s ease; }
        .progress-text { font-size: 0.85rem; margin-top: 8px; display: flex; justify-content: space-between; font-weight: bold; color: rgba(255,255,255,0.9); }
        
        .lesson-list { list-style: none; padding: 0; margin: 0; }
        .lesson-item { border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: all 0.2s; padding: 18px 25px; display: flex; align-items: flex-start; gap: 12px; }
        .lesson-item:hover { background-color: #f8f9fa; }
        .lesson-item.active { background-color: #eef1f4; border-left: 5px solid var(--color-acento); }
        .lesson-item.completed .lesson-title { color: #888; text-decoration: line-through; }
        .check-icon { width: 22px; height: 22px; border: 2px solid #ccc; border-radius: 50%; flex-shrink: 0; margin-top: 2px; display: flex; align-items: center; justify-content: center; font-size: 12px; color: transparent; }
        .lesson-item.completed .check-icon { background-color: #27ae60; border-color: #27ae60; color: white; }
        .lesson-title { font-size: 0.95rem; font-weight: 700; color: #2c3e50; margin-bottom: 4px; display: block; }
        .lesson-meta { font-size: 0.8rem; color: #7f8c8d; text-transform: uppercase; }

        .course-content { padding: 40px 60px; max-width: 1200px; margin: 0 auto; }

        /* HUB DE ACCESO (CLASES EN VIVO) */
        .hub-card {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            border-radius: 15px; padding: 25px; color: white; margin-bottom: 40px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 10px 25px rgba(52, 152, 219, 0.3);
        }
        .hub-info h3 { margin: 0 0 5px 0; font-size: 1.5rem; font-family: 'Playfair Display', serif; }
        .hub-info p { margin: 0; opacity: 0.9; font-size: 1rem; }
        .hub-actions { display: flex; gap: 10px; }
        .btn-hub { background: var(--color-acento); color: var(--color-azul-profundo); border: none; padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; text-decoration: none; display: flex; align-items: center; gap: 8px; transition: transform 0.2s; }
        .btn-hub:hover { transform: translateY(-3px); }
        .btn-hub-sec { background: rgba(255,255,255,0.2); color: white; padding: 10px 20px; border-radius: 8px; text-decoration: none; font-weight: bold; border: 1px solid rgba(255,255,255,0.4); }

        /* VIDEO Y TABS */
        .video-wrapper { position: relative; padding-bottom: 56.25%; height: 0; background: black; border-radius: 12px; overflow: hidden; box-shadow: 0 20px 40px rgba(0,0,0,0.2); margin-bottom: 30px; }
        .video-wrapper iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0; }
        
        .tabs-container { background: white; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); padding: 25px; }
        .tabs-header { display: flex; border-bottom: 2px solid #f0f0f0; margin-bottom: 20px; }
        .tab-btn { background: none; border: none; padding: 10px 20px; font-size: 1rem; font-weight: bold; color: #7f8c8d; cursor: pointer; position: relative; }
        .tab-btn.active { color: var(--color-azul-profundo); }
        .tab-btn.active::after { content: ''; position: absolute; bottom: -2px; left: 0; width: 100%; height: 3px; background: var(--color-acento); }
        
        .tab-content { display: none; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }
        
        .btn-complete { background-color: #e0e0e0; color: #555; padding: 12px 25px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; float: right; }
        .btn-complete.completed { background-color: #27ae60; color: white; }

        /* Planes */
        .plan-features { background-color: #f1f8ff; padding: 20px; border-radius: 8px; margin-bottom: 25px; border-left: 5px solid var(--color-acento); }
        .plan-features ul { margin: 10px 0 0 20px; padding: 0; }
        .plan-features li { margin-bottom: 8px; color: #555; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @media (max-width: 900px) {
            .classroom-container { display: block; }
            .course-sidebar { position: relative; width: 100%; height: auto; top: 0; border-right: none; z-index: 100; }
            .course-content { padding: 20px; }
            .hub-card { flex-direction: column; text-align: center; gap: 20px; }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="container">
            <img src="images/logo-tamar.png" alt="Logo Tamar" class="logo">
            <nav class="nav">
                <ul>
                    <li><a href="index.html">Inicio</a></li>
                    <li><a href="#" id="logout-btn">Cerrar Sesi√≥n</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <div id="loading-screen" style="text-align: center; padding: 100px;">
        <div style="font-size: 2rem; margin-bottom: 20px;">üéì</div>
        <p>Cargando plataforma...</p>
    </div>

    <div id="classroom-ui" class="classroom-container" style="display: none;">
        <aside class="course-sidebar">
            <div class="sidebar-header">
                <h4>Tu Progreso</h4>
                <div class="progress-container">
                    <div class="progress-bar-bg"><div id="progress-fill" class="progress-bar-fill"></div></div>
                    <div class="progress-text"><span id="progress-percent">0%</span><span id="progress-count">0/0</span></div>
                </div>
            </div>
            <ul id="lesson-list-ul" class="lesson-list"></ul>
        </aside>

        <main class="course-content">
            
            <div class="hub-card">
                <div class="hub-info">
                    <h3>üî¥ Aula Virtual en Vivo</h3>
                    <p>Acceso directo a tus clases con profesores.</p>
                </div>
                <div class="hub-actions">
                    <a href="#" id="btn-zoom-fixed" target="_blank" class="btn-hub">üé• Entrar a Clase</a>
                    <a href="#" class="btn-hub-sec" onclick="alert('Los horarios se env√≠an al grupo de WhatsApp.')">üìÖ Ver Horarios</a>
                </div>
            </div>

            <div id="video-area">
                <div class="video-wrapper"><iframe id="main-video-frame" src="" allow="autoplay; encrypted-media" allowfullscreen></iframe></div>
                
                <div class="tabs-container">
                    <div class="tabs-header">
                        <button id="btn-tab-desc" class="tab-btn active" onclick="switchTab('desc')">üìñ Descripci√≥n</button>
                        <button id="btn-tab-resources" class="tab-btn" onclick="switchTab('resources')">üìÇ Recursos</button>
                        <button id="btn-tab-support" class="tab-btn" onclick="switchTab('support')">üí¨ Soporte</button>
                    </div>

                    <div id="tab-desc" class="tab-content active">
                        <div style="overflow: hidden;"> <button id="btn-mark-complete" class="btn-complete">Marcar como Vista</button>
                            <button id="btn-next-lesson" class="btn-complete" style="float:left; display:none; background:var(--color-azul-profundo); color:white; margin-right:10px;">Siguiente ‚Üí</button>
                        </div>
                        <h2 id="main-video-title" style="margin-top: 15px; color: var(--color-azul-profundo);">...</h2>
                        <p id="main-video-desc" style="color: #555; line-height: 1.6;">...</p>
                    </div>

                    <div id="tab-resources" class="tab-content">
                        <h3>Materiales de esta Lecci√≥n</h3>
                        <p>Recursos seleccionados para trabajar este tema:</p>
                        <div id="resources-container" style="margin-top: 20px;">
                            </div>
                    </div>

                    <div id="tab-support" class="tab-content">
                        <h3>¬øDudas sobre este tema?</h3>
                        <p>Contacta a tu tutor o soporte t√©cnico.</p>
                        <div style="display: flex; gap: 15px; margin-top: 20px;">
                            <a href="https://wa.me/5493412757827" target="_blank" class="btn-hub" style="background: #25D366;">üì± WhatsApp Profesores</a>
                            <a href="mailto:educaciontamar@gmail.com" class="btn-hub" style="background: #333;">üìß Soporte T√©cnico</a>
                        </div>
                    </div>
                </div>
            </div>
            <div id="video-message" class="message" style="display:none;"></div>
        </main>
    </div>

    <footer><div class="container"><p>&copy; 2024 Tamar. Plataforma Educativa.</p></div></footer>

    <script type="module" src="js/api.js"></script>
    <script type="module" src="js/main.js"></script>
    <script type="module">
        import { getData, postData, getAuthToken } from './js/api.js';
        import { showMessage } from './js/main.js';

        const PLAN_DETAILS = {
            'basico': { features: ['Acceso a videos cortos', 'Comunidad en l√≠nea', 'Grupo de estudio', 'Clases de ARTE gratis', 'Asesoramiento carpeta', 'Descuento SKEPSI'] },
            'core': { features: ['Todo lo del Plan B√°sico', '3 Clases grupales mensuales', 'Elecci√≥n de 3 docentes', 'Comunidad con docentes', 'Descuento clases extras'] },
            'plus': { features: ['Todo lo del Plan B√°sico', '10 Clases grupales mensuales', 'Elecci√≥n de docentes', 'Comunidad con docentes', 'Descuento clases extras'] },
            'selecto': { features: ['Todo lo del Plan B√°sico', '4 Clases SEMANALES', '40 min m√≠nimo por clase', 'Elecci√≥n de 4 profesores', 'Comunidad con profesores'] },
            'completo': { features: ['Todo lo del Plan B√°sico', '10 Clases SEMANALES', 'Incluye 10 materias b√°sicas', '40 min m√≠nimo por clase', 'Comunidad con profesores'] },
            'certificacion': { features: ['Matr√≠cula Integrative Learning (USA)', 'Constancia y Credencial', 'Acreditaci√≥n acad√©mica', 'Gesti√≥n de Transcript y Diploma', 'Asesoramiento legal'] }
        };

        let allVideos = [];
        let currentVideoIndex = 0;

        // --- TABS LOGIC ---
        window.switchTab = (tabName) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');
            const btn = document.getElementById(`btn-tab-${tabName}`);
            if(btn) btn.classList.add('active');
        };

        document.addEventListener('DOMContentLoaded', async () => {
            const token = getAuthToken();
            if (!token) { window.location.href = 'login.html'; return; }

            document.getElementById('logout-btn').addEventListener('click', (e) => {
                e.preventDefault(); localStorage.removeItem('token'); window.location.href = 'index.html';
            });

            // Pagos (Igual que antes)
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('status') === 'success') {
                showMessage('video-message', '¬°Pago exitoso!', 'success');
                setTimeout(() => window.location.href = 'videos.html', 3000);
            }
            if (urlParams.get('status') === 'paypal_success' && urlParams.get('token')) {
                try { await postData('capturar-pago-paypal', { orderID: urlParams.get('token'), planId: urlParams.get('plan') }, token); setTimeout(() => window.location.href = 'videos.html', 3000); } catch(e) {}
            }

            // CARGAR CONTENIDO
            try {
                const response = await getData('videos', token);
                const data = await response.json();
                document.getElementById('loading-screen').style.display = 'none';

                if (response.ok) {
                    if (data.videos && data.videos.length > 0) {
                        allVideos = data.videos;
                        document.getElementById('classroom-ui').style.display = 'grid';
                        renderSidebar(allVideos);
                        const firstUnwatched = allVideos.findIndex(v => !v.completado);
                        loadVideo(firstUnwatched !== -1 ? firstUnwatched : 0);
                        
                        // CARGAR LINK FIJO (Del √∫ltimo evento creado por Sof√≠a)
                        loadFixedZoomLink(token);
                    } else {
                        document.getElementById('classroom-ui').style.display = 'grid';
                        document.querySelector('.course-content').innerHTML = '<div style="padding:50px; text-align:center;"><h3>¬°Bienvenido!</h3><p>A√∫n no hay lecciones publicadas.</p></div>';
                    }
                } else if (response.status === 403 && data.requierePago) {
                    renderPaymentWall();
                }
            } catch (error) { showMessage('video-message', 'Error de conexi√≥n.', 'error'); }
        });

        function renderSidebar(videos) {
            const ul = document.getElementById('lesson-list-ul');
            ul.innerHTML = videos.map((video, index) => `
                <li class="lesson-item ${video.completado ? 'completed' : ''}" onclick="window.loadVideo(${index})">
                    <div class="check-icon">‚úî</div>
                    <div class="lesson-info"><span class="lesson-title">${video.titulo_corto || video.titulo_completo}</span><span class="lesson-meta">M√≥dulo ${video.modulo}</span></div>
                </li>
            `).join('');
            updateProgress(videos);
        }

        window.loadVideo = (index) => {
            currentVideoIndex = index;
            const video = allVideos[index];
            document.querySelectorAll('.lesson-item').forEach((el, i) => el.classList.toggle('active', i === index));
            
            let url = video.url_video || '';
            if(url.includes('watch?v=')) url = url.replace('watch?v=', 'embed/');
            document.getElementById('main-video-frame').src = url;
            document.getElementById('main-video-title').textContent = video.titulo_completo;
            
            // --- L√ìGICA INTELIGENTE DE RECURSOS ---
            // Extraemos el link de la descripci√≥n si existe
            const desc = video.descripcion || '';
            // Regex simple para encontrar URLs
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            const links = desc.match(urlRegex);
            
            // Limpiamos la descripci√≥n de links feos para mostrar texto limpio
            const cleanDesc = desc.replace(urlRegex, '').trim() || 'Sin descripci√≥n adicional.';
            document.getElementById('main-video-desc').textContent = cleanDesc;

            const resContainer = document.getElementById('resources-container');
            if (links && links.length > 0) {
                resContainer.innerHTML = links.map(link => `
                    <a href="${link}" target="_blank" class="btn-hub" style="background: #fff; color: #333; border: 1px solid #ccc; margin-bottom: 10px; justify-content: center;">
                        üìÇ Descargar Material Adjunto
                    </a>
                `).join('');
            } else {
                resContainer.innerHTML = `
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px dashed #ccc; text-align: center;">
                        <p style="color: #666; margin:0;">No hay material espec√≠fico adjunto.</p>
                        <small>Consulta la carpeta general de tu grado.</small>
                    </div>
                `;
            }

            switchTab('desc');

            const btnComplete = document.getElementById('btn-mark-complete');
            const btnNext = document.getElementById('btn-next-lesson');
            
            if (video.completado) {
                btnComplete.textContent = '‚úÖ Completada'; 
                btnComplete.classList.add('completed');
                btnComplete.disabled = true;
                if (index < allVideos.length - 1) btnNext.style.display = 'inline-block';
            } else {
                btnComplete.textContent = 'Marcar como Vista'; 
                btnComplete.classList.remove('completed');
                btnComplete.disabled = false; 
                btnNext.style.display = 'none';
            }
        };

        // --- BUSCA EL √öLTIMO LINK DE ZOOM CARGADO ---
        async function loadFixedZoomLink(token) {
            try {
                const res = await getData('clases-en-vivo', token);
                const data = await res.json();
                // Buscamos cualquier clase que tenga link, asumimos que es el fijo
                if (data.clases && data.clases.length > 0) {
                    // Tomamos el √∫ltimo link cargado
                    const ultimo = data.clases[data.clases.length - 1]; 
                    if (ultimo.link_zoom) {
                        document.getElementById('btn-zoom-fixed').href = ultimo.link_zoom;
                    }
                }
            } catch (e) { console.error(e); }
        }

        document.getElementById('btn-mark-complete').addEventListener('click', async () => {
            const btn = document.getElementById('btn-mark-complete');
            const originalText = btn.textContent;
            btn.textContent = 'Guardando...';
            btn.disabled = true;
            try {
                const res = await postData('progreso', { videoId: allVideos[currentVideoIndex].id }, getAuthToken());
                if (res.ok) { 
                    allVideos[currentVideoIndex].completado = true; 
                    renderSidebar(allVideos); 
                    loadVideo(currentVideoIndex); 
                }
            } catch (e) { btn.textContent = originalText; btn.disabled = false; }
        });

        document.getElementById('btn-next-lesson').addEventListener('click', () => { if (currentVideoIndex < allVideos.length - 1) loadVideo(currentVideoIndex + 1); });

        function updateProgress(videos) {
            const completedCount = videos.filter(v => v.completado).length;
            const percent = Math.round((completedCount / videos.length) * 100);
            document.getElementById('progress-fill').style.width = `${percent}%`;
            document.getElementById('progress-percent').textContent = `${percent}%`;
            document.getElementById('progress-count').textContent = `${completedCount}/${videos.length}`;
        }

        function renderPaymentWall() {
            const container = document.getElementById('classroom-ui');
            container.style.display = 'block';
            document.querySelector('.course-sidebar').style.display = 'none';
            document.querySelector('.course-content').style.marginLeft = '0';
            document.querySelector('.course-content').style.maxWidth = '100%';
            
            // (Aqu√≠ va el mismo HTML del Payment Wall que ya ten√≠as)
            // Para ahorrar espacio en el chat, asumo que ya lo tienes del mensaje anterior
            // Si lo necesitas de nuevo, av√≠same. 
            // IMPORTANTE: COPIA EL BLOQUE content.innerHTML = `...` DEL C√ìDIGO ANTERIOR AQU√ç.
             document.querySelector('.course-content').innerHTML = `
                <div style="text-align: center; padding: 40px; max-width: 900px; margin: 0 auto;">
                    <h1 style="color: var(--color-azul-profundo); margin-bottom: 10px;">üîí Inscripci√≥n a Tamar</h1>
                    <p style="font-size: 1.1rem; margin-bottom: 30px; color:#666;">Selecciona el plan educativo para ver sus beneficios.</p>
                    <div style="background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);">
                        <div style="margin-bottom: 20px; text-align: left;">
                            <label style="display:block; font-weight:bold; margin-bottom:10px; color: var(--color-azul-profundo);">Elige tu Plan:</label>
                            <select id="plan-selector" style="width:100%; padding:15px; border-radius:8px; border:2px solid #eee; font-size:1.1rem; font-family: 'Lato', sans-serif;">
                                <option value="basico" data-ars="46800" data-usd="39">Plan B√°sico ($46.800 ARS / $39 USD)</option>
                                <option value="core" data-ars="70800" data-usd="59">Plan Core ($70.800 ARS / $59 USD)</option>
                                <option value="plus" data-ars="154800" data-usd="129">Plan Plus ($154.800 ARS / $129 USD)</option>
                                <option value="selecto" data-ars="130800" data-usd="109">Plan Selecto ($130.800 ARS / $109 USD)</option>
                                <option value="completo" data-ars="274800" data-usd="229">Plan Completo ($274.800 ARS / $229 USD)</option>
                                <option value="certificacion" data-ars="240000" data-usd="200">Certificaci√≥n Anual ($240.000 ARS / $200 USD)</option>
                            </select>
                        </div>
                        <div id="plan-features-container" class="plan-features"><h4>‚ú® Incluye:</h4><ul id="features-list"></ul></div>
                        <div style="display: grid; gap: 20px; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));">
                            <div style="border: 1px solid #eee; padding: 20px; border-radius: 8px;">
                                <h4>üá¶üá∑ Argentina</h4>
                                <p id="price-display-ars" style="font-size: 1.5rem; color: var(--color-acento); font-weight:bold; margin: 10px 0;">$46.800 ARS</p>
                                <button onclick="window.pagarMP()" class="btn" style="width:100%; background: #009ee3;">Pagar con Mercado Pago</button>
                            </div>
                            <div style="border: 1px solid #eee; padding: 20px; border-radius: 8px;">
                                <h4>üåç Internacional</h4>
                                <p id="price-display-usd" style="font-size: 1.5rem; color: var(--color-acento); font-weight:bold; margin: 10px 0;">$39 USD</p>
                                <button onclick="window.pagarPayPal()" class="btn" style="width:100%; background: #ffc439; color: #003087;">Pagar con PayPal</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            const updatePlanInfo = () => {
                const selector = document.getElementById('plan-selector');
                const opt = selector.options[selector.selectedIndex];
                const list = document.getElementById('features-list');
                document.getElementById('price-display-ars').textContent = `$${new Intl.NumberFormat('es-AR').format(opt.getAttribute('data-ars'))} ARS`;
                document.getElementById('price-display-usd').textContent = `$${opt.getAttribute('data-usd')} USD`;
                list.innerHTML = PLAN_DETAILS[opt.value] ? PLAN_DETAILS[opt.value].features.map(f => `<li>${f}</li>`).join('') : '';
            };
            document.getElementById('plan-selector').addEventListener('change', updatePlanInfo);
            updatePlanInfo();
            
            window.pagarMP = async () => {
                const token = getAuthToken();
                const planId = document.getElementById('plan-selector').value;
                try { const res = await postData('crear-pago', { planId }, token); const data = await res.json(); if (data.init_point) window.location.href = data.init_point; } catch (e) { alert('Error MP'); }
            };
            window.pagarPayPal = async () => {
                const token = getAuthToken();
                const planId = document.getElementById('plan-selector').value;
                try { const res = await postData('crear-pago-paypal', { planId }, token); const data = await res.json(); const link = data.links.find(l => l.rel === 'approve'); if (link) window.location.href = link.href; } catch (e) { alert('Error PayPal'); }
            };
        }
    </script>
</body>
</html>
