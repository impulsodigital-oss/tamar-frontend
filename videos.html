<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tamar - Mis Cursos</title>
    <link rel="stylesheet" href="CSS/style.css">
</head>
<body>
    <header class="header">
        <div class="container">
            <img src="images/logo-tamar.png" alt="Logo Tamar" class="logo">
            <nav class="nav">
                <ul>
                    <li><a href="index.html">Inicio</a></li>
                    <li><a href="#" id="logout-btn">Cerrar Sesi贸n</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <div class="container main-content">
        <h2>Mi Biblioteca de Cursos</h2>
        
        <div id="video-list">
            <p>Cargando contenido...</p>
        </div>

        <div id="video-message" class="message" style="display:none;"></div>
    </div>

    <footer>
        <div class="container">
            <p>&copy; 2024 Tamar. Todos los derechos reservados.</p>
        </div>
    </footer>

    <script type="module" src="js/api.js"></script>
    <script type="module" src="js/main.js"></script>
    
    <script type="module">
        import { showMessage, hideMessage, getData, postData, getAuthToken } from './js/main.js';

        document.addEventListener('DOMContentLoaded', async () => {
            const token = getAuthToken();
            const videoListDiv = document.getElementById('video-list');
            
            if (!token) {
                window.location.href = 'login.html';
                return;
            }

            // LOGOUT
            document.getElementById('logout-btn').addEventListener('click', (e) => {
                e.preventDefault();
                localStorage.removeItem('token');
                window.location.href = 'index.html';
            });

            // 1. CHECK URL PARAMS (Retorno de PayPal o Mercado Pago)
            const urlParams = new URLSearchParams(window.location.search);
            
            // A) Retorno de Mercado Pago
            if (urlParams.get('status') === 'success') {
                showMessage('video-message', '隆Pago con Mercado Pago exitoso! Tu cuenta se est谩 activando...', 'success');
                setTimeout(() => { window.location.href = 'videos.html'; }, 3000); // Limpiar URL
            }
            
            // B) Retorno de PayPal
            if (urlParams.get('status') === 'paypal_success' && urlParams.get('token')) {
                showMessage('video-message', 'Procesando pago de PayPal...', 'success');
                try {
                    // Capturar el pago en el backend
                    const response = await postData('capturar-pago-paypal', { orderID: urlParams.get('token') }, token);
                    if (response.ok) {
                        showMessage('video-message', '隆Pago Internacional Aprobado! Bienvenido.', 'success');
                        setTimeout(() => { window.location.href = 'videos.html'; }, 3000);
                    } else {
                        showMessage('video-message', 'Hubo un problema al confirmar el pago de PayPal.', 'error');
                    }
                } catch (error) {
                    console.error(error);
                }
            }

            // 2. CARGAR VIDEOS O MOSTRAR PAGOS
            try {
                const response = await getData('videos', token);
                const data = await response.json();

                if (response.ok) {
                    // -- CASO: ALUMNO ACTIVO --
                    if (data.videos && data.videos.length > 0) {
                        videoListDiv.innerHTML = data.videos.map(video => `
                            <div class="video-item">
                                <div>
                                    <h3>${video.titulo_completo}</h3>
                                    <p>${video.titulo_corto} (M贸dulo ${video.modulo})</p>
                                </div>
                                ${video.completado 
                                    ? '<button class="btn" disabled style="opacity:0.7; background:#ccc; color:#333; box-shadow:none;">Completado</button>' 
                                    : `<button class="btn mark-completed-btn" data-video-id="${video.id}">Marcar Visto</button>`}
                            </div>
                        `).join('');

                        document.querySelectorAll('.mark-completed-btn').forEach(btn => {
                            btn.addEventListener('click', (e) => markAsCompleted(e.target.dataset.videoId));
                        });
                    } else {
                        videoListDiv.innerHTML = '<p>No hay videos cargados a煤n.</p>';
                    }

                } else if (response.status === 403 && data.requierePago) {
                    // -- CASO: FALTA PAGO (MOSTRAR OPCIONES) --
                    videoListDiv.innerHTML = `
                        <div style="text-align: center; padding: 40px; border: 1px solid #ddd; border-radius: 12px; background: white; max-width: 600px; margin: 0 auto;">
                            <h3 style="color: #e0419d; margin-bottom: 15px;"> Contenido Exclusivo</h3>
                            <p style="margin-bottom: 30px;">Para acceder a la Certificaci贸n y Biblioteca de Tamar, debes realizar la matr铆cula anual.</p>
                            
                            <div style="display: grid; gap: 20px; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));">
                                <div style="border: 1px solid #eee; padding: 20px; border-radius: 8px;">
                                    <h4> Desde Argentina</h4>
                                    <p style="font-size: 0.9rem; color: #666;">Tarjetas de d茅bito, cr茅dito y dinero en cuenta.</p>
                                    <p><strong>$50.000 ARS</strong></p>
                                    <button onclick="pagarMP()" class="btn" style="width:100%; background-color: #009ee3; margin-top: 10px;">Pagar con Mercado Pago</button>
                                </div>

                                <div style="border: 1px solid #eee; padding: 20px; border-radius: 8px;">
                                    <h4> Internacional</h4>
                                    <p style="font-size: 0.9rem; color: #666;">Cualquier pa铆s (USD). Tarjetas internacionales.</p>
                                    <p><strong>$50.00 USD</strong></p>
                                    <button onclick="pagarPayPal()" class="btn" style="width:100%; background-color: #ffc439; color: #003087; margin-top: 10px;">Pagar con PayPal</button>
                                </div>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error(error);
                showMessage('video-message', 'Error de conexi贸n.', 'error');
            }
        });

        // Funciones Globales para los botones
        window.pagarMP = async () => {
            const token = getAuthToken();
            showMessage('video-message', 'Conectando con Mercado Pago...', 'success');
            try {
                const response = await postData('crear-pago', {}, token);
                const data = await response.json();
                if (data.init_point) window.location.href = data.init_point;
            } catch (e) { showMessage('video-message', 'Error al iniciar pago.', 'error'); }
        };

        window.pagarPayPal = async () => {
            const token = getAuthToken();
            showMessage('video-message', 'Conectando con PayPal...', 'success');
            try {
                const response = await postData('crear-pago-paypal', {}, token);
                const data = await response.json();
                // PayPal devuelve una lista de links, buscamos el de "approve"
                const approveLink = data.links.find(link => link.rel === 'approve');
                if (approveLink) window.location.href = approveLink.href;
                else showMessage('video-message', 'Error configuraci贸n PayPal.', 'error');
            } catch (e) { showMessage('video-message', 'Error al iniciar PayPal.', 'error'); }
        };

        async function markAsCompleted(videoId) {
             const token = getAuthToken();
             try {
                const response = await postData('progreso', { videoId }, token);
                if(response.ok) { 
                    window.location.reload();
                }
             } catch (e) { console.error(e); }
        }
    </script>
</body>
</html>
