<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aula Virtual - Tamar</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="CSS/style.css">
</head>
<body>
    <header class="header">
        <div class="container">
            <img src="images/logo-tamar.png" alt="Logo Tamar" class="logo">
            <nav class="nav">
                <ul>
                    <li><a href="index.html">Inicio</a></li>
                    <li><a href="#" onclick="window.mostrarClasesVivo()" style="color: var(--color-acento); font-weight: bold;">üî¥ Clases en Vivo</a></li>
                    <li><a href="#" id="logout-btn">Cerrar Sesi√≥n</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <div id="loading-screen" style="text-align: center; padding: 100px;">
        <p>Cargando tu aula virtual...</p>
    </div>

    <div id="classroom-ui" class="classroom-container" style="display: none;">
        
        <aside class="course-sidebar">
            <div class="sidebar-header">
                <h4>Tu Progreso</h4>
                <div class="progress-container">
                    <div class="progress-bar-bg">
                        <div id="progress-fill" class="progress-bar-fill"></div>
                    </div>
                    <div class="progress-text">
                        <span id="progress-percent">0% Completado</span>
                        <span id="progress-count">0/0 Lecciones</span>
                    </div>
                </div>
            </div>
            <ul id="lesson-list-ul" class="lesson-list">
                </ul>
        </aside>

        <main class="course-content">
            <div id="video-area">
                <div class="video-wrapper">
                    <iframe id="main-video-frame" src="" allow="autoplay; encrypted-media" allowfullscreen></iframe>
                </div>
                
                <div class="lesson-header">
                    <h2 id="main-video-title">Selecciona una lecci√≥n</h2>
                    <p id="main-video-desc" style="color: #666;">...</p>
                    
                    <div style="margin-top: 20px; display: flex; justify-content: space-between; align-items: center;">
                        <button id="btn-mark-complete" class="btn" style="background-image: none; background-color: #ccc;">
                            Marcar como Vista
                        </button>
                        
                        <button id="btn-next-lesson" class="btn" style="display:none;">
                            Siguiente Lecci√≥n ‚Üí
                        </button>
                    </div>
                </div>
            </div>

            <div id="video-message" class="message" style="display:none;"></div>
        </main>
    </div>

    <div id="live-modal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-modal" onclick="document.getElementById('live-modal').style.display='none'">&times;</span>
            <h2 style="color: var(--color-azul-profundo); border-bottom: 2px solid #eee; padding-bottom: 15px; margin-bottom: 20px;">üìÖ Calendario de Clases en Vivo</h2>
            <div id="live-classes-list">
                <p>Cargando clases...</p>
            </div>
        </div>
    </div>

    <footer>
        <div class="container">
            <p>&copy; 2024 Tamar. Plataforma Educativa.</p>
        </div>
    </footer>

    <script type="module" src="js/api.js"></script>
    <script type="module" src="js/main.js"></script>
    
    <script type="module">
        import { showMessage, hideMessage, getData, postData, getAuthToken } from './js/main.js';

        let allVideos = [];
        let currentVideoIndex = 0;

        document.addEventListener('DOMContentLoaded', async () => {
            const token = getAuthToken();
            
            if (!token) {
                window.location.href = 'login.html';
                return;
            }

            // LOGOUT
            document.getElementById('logout-btn').addEventListener('click', (e) => {
                e.preventDefault();
                localStorage.removeItem('token');
                window.location.href = 'index.html';
            });

            // 1. L√ìGICA DE PAGOS (Check URL)
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('status') === 'success') {
                showMessage('video-message', '¬°Pago con Mercado Pago exitoso! Activando...', 'success');
                setTimeout(() => window.location.href = 'videos.html', 3000);
            }
            if (urlParams.get('status') === 'paypal_success' && urlParams.get('token')) {
                showMessage('video-message', 'Procesando PayPal...', 'success');
                try {
                    const response = await postData('capturar-pago-paypal', { orderID: urlParams.get('token') }, token);
                    if(response.ok) setTimeout(() => window.location.href = 'videos.html', 3000);
                } catch(e) { console.error(e); }
            }

            // 2. CARGAR DATOS DEL CURSO
            try {
                const response = await getData('videos', token);
                const data = await response.json();

                document.getElementById('loading-screen').style.display = 'none';

                if (response.ok) {
                    // CASO: ALUMNO ACTIVO
                    if (data.videos && data.videos.length > 0) {
                        allVideos = data.videos;
                        document.getElementById('classroom-ui').style.display = 'grid';
                        
                        renderSidebar(allVideos);
                        
                        // Cargar el primer video no visto
                        const firstUnwatched = allVideos.findIndex(v => !v.completado);
                        loadVideo(firstUnwatched !== -1 ? firstUnwatched : 0);

                    } else {
                        // Si pag√≥ pero no hay videos cargados en DB
                        document.querySelector('.main-content').innerHTML = '<div style="padding:50px; text-align:center;"><h3>¬°Bienvenido!</h3><p>A√∫n no hay lecciones publicadas. Vuelve pronto.</p></div>';
                    }

                } else if (response.status === 403 && data.requierePago) {
                    // CASO: NO PAGO (Mostrar Bloqueo)
                    document.querySelector('.main-content').innerHTML = `
                        <div style="text-align: center; padding: 60px; max-width: 800px; margin: 0 auto;">
                            <h1 style="color: var(--color-azul-profundo); margin-bottom: 20px;">üîí Acceso Exclusivo para Alumnos</h1>
                            <p style="font-size: 1.2rem; margin-bottom: 40px;">Est√°s a un paso de entrar a la academia. Elige tu m√©todo de pago para comenzar.</p>
                            
                            <div style="display: grid; gap: 30px; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));">
                                <div class="card" style="text-align: center; align-items: center;">
                                    <h3>üá¶üá∑ Argentina</h3>
                                    <p>Mercado Pago (D√©bito/Cr√©dito)</p>
                                    <h2 style="color: var(--color-acento);">$50.000 ARS</h2>
                                    <button onclick="window.pagarMP()" class="btn" style="width:100%; background: #009ee3;">Pagar Ahora</button>
                                </div>
                                <div class="card" style="text-align: center; align-items: center;">
                                    <h3>üåç Internacional</h3>
                                    <p>PayPal (D√≥lares USD)</p>
                                    <h2 style="color: var(--color-acento);">$50 USD</h2>
                                    <button onclick="window.pagarPayPal()" class="btn" style="width:100%; background: #ffc439; color: #003087;">Pagar con PayPal</button>
                                </div>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error(error);
                showMessage('video-message', 'Error de conexi√≥n.', 'error');
            }
        });

        // --- FUNCIONES DEL REPRODUCTOR ---

        function renderSidebar(videos) {
            const ul = document.getElementById('lesson-list-ul');
            ul.innerHTML = videos.map((video, index) => `
                <li class="lesson-item ${video.completado ? 'completed' : ''}" onclick="loadVideo(${index})">
                    <div class="check-icon">${video.completado ? '‚úî' : ''}</div>
                    <div class="lesson-info">
                        <span class="lesson-title">${video.titulo_corto || video.titulo_completo}</span>
                        <span class="lesson-meta">M√≥dulo ${video.modulo}</span>
                    </div>
                </li>
            `).join('');
            updateProgress(videos);
        }

        window.loadVideo = (index) => {
            currentVideoIndex = index;
            const video = allVideos[index];
            
            // UI Activa
            document.querySelectorAll('.lesson-item').forEach((el, i) => el.classList.toggle('active', i === index));

            // Video Iframe
            const iframe = document.getElementById('main-video-frame');
            let url = video.url_video || '';
            if(url.includes('watch?v=')) url = url.replace('watch?v=', 'embed/');
            iframe.src = url;

            // Textos
            document.getElementById('main-video-title').textContent = video.titulo_completo;
            document.getElementById('main-video-desc').textContent = video.descripcion || '';

            // Botones
            const btnComplete = document.getElementById('btn-mark-complete');
            const btnNext = document.getElementById('btn-next-lesson');
            
            if (video.completado) {
                btnComplete.textContent = '‚úÖ Lecci√≥n Completada';
                btnComplete.style.backgroundColor = '#28a745';
                btnComplete.disabled = true;
                if (index < allVideos.length - 1) btnNext.style.display = 'inline-block';
            } else {
                btnComplete.textContent = 'Marcar como Vista';
                btnComplete.style.backgroundColor = 'var(--color-acento)';
                btnComplete.disabled = false;
                btnNext.style.display = 'none';
            }
        };

        document.getElementById('btn-mark-complete').addEventListener('click', async () => {
            const video = allVideos[currentVideoIndex];
            const token = getAuthToken();
            try {
                const res = await postData('progreso', { videoId: video.id }, token);
                if (res.ok) {
                    allVideos[currentVideoIndex].completado = true;
                    renderSidebar(allVideos);
                    loadVideo(currentVideoIndex);
                }
            } catch (e) { console.error(e); }
        });

        document.getElementById('btn-next-lesson').addEventListener('click', () => {
            if (currentVideoIndex < allVideos.length - 1) loadVideo(currentVideoIndex + 1);
        });

        function updateProgress(videos) {
            const completedCount = videos.filter(v => v.completado).length;
            const total = videos.length;
            const percent = total === 0 ? 0 : Math.round((completedCount / total) * 100);
            document.getElementById('progress-fill').style.width = `${percent}%`;
            document.getElementById('progress-percent').textContent = `${percent}% Completado`;
            document.getElementById('progress-count').textContent = `${completedCount}/${total} Lecciones`;
        }

        // --- FUNCIONES GLOBALES (Pagos y Clases en Vivo) ---
        
        window.pagarMP = async () => {
            const token = getAuthToken();
            try {
                const res = await postData('crear-pago', {}, token);
                const data = await res.json();
                if (data.init_point) window.location.href = data.init_point;
            } catch (e) { alert('Error al conectar con Mercado Pago'); }
        };

        window.pagarPayPal = async () => {
            const token = getAuthToken();
            try {
                const res = await postData('crear-pago-paypal', {}, token);
                const data = await res.json();
                const link = data.links.find(l => l.rel === 'approve');
                if (link) window.location.href = link.href;
            } catch (e) { alert('Error al conectar con PayPal'); }
        };
        
        window.mostrarClasesVivo = async () => {
             const token = getAuthToken();
             document.getElementById('live-modal').style.display = 'flex'; // Abrir modal
             
             try {
                 const res = await getData('clases-en-vivo', token);
                 if(res.status === 403) { 
                     document.getElementById('live-classes-list').innerHTML = '<p style="color:red; text-align:center;">üîí Acceso restringido a alumnos pagos.</p>'; 
                     return; 
                 }
                 const data = await res.json();
                 
                 if(!data.clases || data.clases.length === 0) {
                     document.getElementById('live-classes-list').innerHTML = '<p style="text-align:center;">No hay clases programadas pr√≥ximamente.</p>';
                     return;
                 }

                 // RENDERIZAR TARJETAS DE CLASE
                 document.getElementById('live-classes-list').innerHTML = data.clases.map(c => {
                    const dateObj = new Date(c.fecha_hora);
                    const day = dateObj.getDate();
                    const month = dateObj.toLocaleString('es-ES', { month: 'short' });
                    const time = dateObj.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });

                    return `
                    <div class="live-class-card">
                        <div class="class-date">
                            <span class="date-day">${day}</span>
                            <span class="date-month">${month}</span>
                            <span style="display:block; font-size:0.8rem; margin-top:5px;">${time} hs</span>
                        </div>
                        <div class="class-info">
                            <span class="badge-materia">${c.materia || 'General'}</span>
                            <h3 style="margin: 5px 0; font-size:1.2rem;">${c.titulo}</h3>
                            <p style="margin:0; color:#666; font-size:0.9rem;">üë®‚Äçüè´ ${c.profesor || 'Staff Tamar'}</p>
                            <p style="font-size:0.85rem; color:#888; margin-top:5px;">${c.descripcion || ''}</p>
                        </div>
                        <div class="class-actions">
                            <a href="${c.link_zoom}" target="_blank" class="btn-zoom">üé• Unirse a Zoom</a>
                            ${c.link_recursos ? `<a href="${c.link_recursos}" target="_blank" class="btn-materials">üìÇ Materiales</a>` : ''}
                        </div>
                    </div>
                    `;
                 }).join('');
                 
             } catch(e) { console.error(e); }
        }
    </script>
</body>
</html>
